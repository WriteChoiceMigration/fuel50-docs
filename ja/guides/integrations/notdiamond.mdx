---
- title: Not Diamond ¬◇
- description: Not Diamondを使用して、精度を最大化しコストを節約しながら、ニーズに合った適切なモデルにプロンプトをルーティングします
---

複雑なLLMワークフローを構築する際、ユーザーは精度、コスト、または呼び出しレイテンシーに応じて異なるモデルにプロンプトを送る必要がある場合があります。ユーザーは[Not Diamond][nd]を使用してこれらのワークフローでプロンプトを適切なモデルにルーティングし、精度を最大化しながらモデルコストを節約することができます。

## はじめに

まず[アカウントを作成][account]して[APIキーを生成][keys]し、APIキーを環境変数として`NOTDIAMOND_API_KEY`に追加してください。

!\[[APIキーを作成](imgs/notdiamond/api-keys.png)]

ここから、以下のことができます：

* クイックスタートガイドを[試す][quickstart guide]、
* [カスタムルーターを構築する][custom router]（W\&B WeaveとNot Diamondを使用）、または
* [Not Diamondとチャットする][chat]ことでルーティングの動作を確認できます

## トレーシング

Weaveは[Not DiamondのPythonライブラリ][python]と統合して[API呼び出しを自動的に記録][ops]します。ワークフローの開始時に`weave.init()`を実行するだけで、通常通りルーティングされたプロバイダーを使用できます：

```python
from notdiamond import NotDiamond

import weave
weave.init('notdiamond-quickstart')

client = NotDiamond()
session_id, provider = client.chat.completions.model_select(
    messages=[
        {"role": "system", "content": "You are a helpful assistant."},
        {"role": "user", "content": "Concisely explain merge sort."}
    ],
    model=['openai/gpt-4o', 'anthropic/claude-3-5-sonnet-20240620']
)

print("LLM called: ", provider.provider)  # openai, anthropic, etc
print("Provider model: ", provider.model) # gpt-4o, claude-3-5-sonnet-20240620, etc
```

## カスタムルーティング

また、[カスタムルーター][custom router]を[Evaluations][evals]でトレーニングすることもできます。これにより、Not Diamondは特殊なユースケースの評価パフォーマンスに応じてプロンプトをルーティングできるようになります。

まずカスタムルーターをトレーニングします：

```python
from weave.flow.eval import EvaluationResults
from weave.integrations.notdiamond.custom_router import train_router

# Build an Evaluation on gpt-4o and Claude 3.5 Sonnet
evaluation = weave.Evaluation(...)
gpt_4o = weave.Model(...)
sonnet = weave.Model(...)

model_evals = {
    'openai/gpt-4o': evaluation.get_eval_results(gpt_4o),
    'anthropic/claude-3-5-sonnet-20240620': evaluation.get_eval_results(sonnet),
}
preference_id = train_router(
    model_evals=model_evals,
    prompt_column="prompt",
    response_column="actual",
    language="en",
    maximize=True,
)
```

このプリファレンスIDを任意の`model_select`リクエストで再利用することで、評価データに基づいてパフォーマンスを最大化しコストを最小化するようにプロンプトをルーティングできます：

```python
from notdiamond import NotDiamond
client = NotDiamond()

import weave
weave.init('notdiamond-quickstart')

session_id, provider = client.chat.completions.model_select(
    messages=[
        {"role": "system", "content": "You are a helpful assistant."},
        {"role": "user", "content": "Concisely explain merge sort."}
    ],
    model=['openai/gpt-4o', 'anthropic/claude-3-5-sonnet-20240620'],

    # passing this preference ID reuses your custom router
    preference_id=preference_id
)

print("LLM called: ", provider.provider)  # openai, anthropic, etc
print("Provider model: ", provider.model) # gpt-4o, claude-3-5-sonnet-20240620, etc
```

## 追加サポート

詳細については[ドキュメント][docs]を参照するか、[メッセージを送信][support]してください。

[account]: https://app.notdiamond.ai

[chat]: https://chat.notdiamond.ai

[custom router]: https://docs.notdiamond.ai/docs/router-training-quickstart

[docs]: https://docs.notdiamond.ai

[evals]: ../../guides/core-types/evaluations.md

[keys]: https://app.notdiamond.ai/keys

[nd]: https://www.notdiamond.ai/

[ops]: ../../guides/tracking/ops.md

[python]: https://github.com/Not-Diamond/notdiamond-python

[quickstart guide]: https://docs.notdiamond.ai/docs/quickstart

[support]: mailto:support@notdiamond.ai
